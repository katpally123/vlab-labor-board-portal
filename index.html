<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amazon VLAB | Virtual Labor Assignment Board</title>

  <!-- Tailwind for layout -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- App styles -->
  <link href="styles.css" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">
  <!-- Header: Dayshift IXD Staffing Board title band + OM / Shift Goal blocks -->
  <header class="board-header bg-white shadow px-2 py-3">
    <div class="board-header-row w-full flex items-center justify-between">
      <div class="header-left flex items-center gap-3">
        <div class="small-blocks flex flex-col text-sm">
          <div class="am-pa">AM</div>
          <div class="am-pa">PA</div>
        </div>
      </div>
      <div class="board-title text-center flex-1">
        <div class="main-title">AMAZON VIRTUAL LABOR ASSIGNMENT BOARD</div>
      </div>
      <div class="header-blocks flex items-center gap-3">
        <div class="header-block">
          <div class="hb-label">OM</div>
          <div class="hb-value" id="header-om">‚Äî</div>
        </div>
        <div class="header-block">
          <div class="hb-label">SHIFT GOAL</div>
          <div class="hb-value" id="header-goal">‚Äî</div>
        </div>
        <div class="header-block site-selector">
          <div class="hb-label">üè≠ SITE</div>
          <select id="headerSiteSelector" class="hb-value bg-transparent border-none text-center font-bold cursor-pointer hover:bg-gray-50 rounded text-sm">
            <option value="YDD2">YDD2</option>
            <option value="YDD4">YDD4</option>
            <option value="YHM2">YHM2</option>
          </select>
        </div>
        <div class="header-actions flex items-center gap-2">
          <button class="border border-gray-300 rounded px-2 py-1 text-sm text-gray-700">Settings</button>
          <button class="border border-gray-300 rounded px-2 py-1 text-sm text-gray-700" id="analyticsBtn">Analytics</button>
          <button class="border border-gray-300 rounded px-2 py-1 text-sm text-gray-700" id="exportLogBtn">Export Log</button>
          <button id="lockAssignmentsBtn" class="border border-orange-600 text-orange-600 bg-white hover:bg-orange-50 rounded px-3 py-1 text-sm font-semibold" title="Lock assignments and generate rotation report">üîí Lock & Report</button>
          <button id="publishBtn" class="border border-indigo-600 text-indigo-600 bg-white hover:bg-indigo-50 rounded px-3 py-1 text-sm font-semibold">Publish</button>
        </div>
      </div>
    </div>
  </header>

  <main class="w-full px-2 py-4">
    <!-- Controls -->
    <form id="laborForm" class="bg-white rounded shadow px-6 py-4 flex flex-wrap gap-6 items-end mb-4">
      <div>
        <label for="date" class="block font-semibold mb-1 text-sm">Date</label>
        <input type="date" id="date" name="date" class="border p-2 rounded w-40" required 
               title="Select the schedule date" placeholder="DD/MM/YYYY">
      </div>

      <div>
        <label class="block font-semibold mb-1 text-sm">Shift</label>
        <div class="flex items-center space-x-3">
          <label class="inline-flex items-center">
            <input type="radio" name="shift" value="day" checked class="form-radio" id="shift-day"
                   title="Select day shift">
            <span class="ml-1">Day</span>
          </label>
          <label class="inline-flex items-center">
            <input type="radio" name="shift" value="night" class="form-radio" id="shift-night"
                   title="Select night shift">
            <span class="ml-1">Night</span>
          </label>
        </div>
      </div>

      <div>
        <label for="site" class="block font-semibold mb-1 text-sm">Site</label>
        <select id="site" name="site" class="border p-2 rounded w-28" required
                title="Select the facility site">
          <option value="YHM2">YHM2</option>
          <option value="YDD2">YDD2</option>
          <option value="YDD4">YDD4</option>
        </select>
      </div>

      <div>
        <label for="quarter" class="block font-semibold mb-1 text-sm">Quarter</label>
        <select id="quarter" name="quarter" class="border p-2 rounded w-28" required
                title="Select the quarter period">
          <option value="Q1">Q1</option>
          <option value="Q2">Q2</option>
          <option value="Q3">Q3</option>
        </select>
      </div>

      <div>
        <label for="plannedVolumeStub" class="block font-semibold mb-1 text-sm">Planned Volume</label>
        <input id="plannedVolumeStub" placeholder="e.g., 52000" class="border rounded p-2 w-36" 
               type="number" min="0" title="Enter planned volume for the shift">
      </div>

      <!-- File Uploads -->
      <div class="flex flex-col space-y-1">
        <label class="block font-semibold mb-1 text-sm">Uploads</label>
        <div id="fileZone" class="flex gap-1 flex-wrap">
          <label for="roster" class="pill-label">Roster File
            <input type="file" id="roster" name="roster" accept=".csv" class="hidden"
                   title="Upload CSV file with employee roster data">
            <span class="ml-2 file-label" id="label-roster"></span>
          </label>
          <label for="logins" class="pill-label" style="background: #e0f2fe; border-color: #0284c7;">Daily Logins (Optional)
            <input type="file" id="logins" name="logins" accept=".csv" class="hidden"
                   title="Upload CSV file with daily login data to filter present associates">
            <span class="ml-2 file-label" id="label-logins"></span>
          </label>
        </div>
        <div class="text-xs text-gray-600 mt-1">
          <button type="button" id="downloadTemplateBtn" class="text-blue-600 hover:text-blue-800 underline"
                  title="Download CSV template for roster data">üìÑ Download Roster Template</button>
          <span class="mx-2">‚Ä¢</span>
          <button type="button" id="downloadLoginTemplateBtn" class="text-blue-600 hover:text-blue-800 underline"
                  title="Download CSV template for login data">üìÑ Download Login Template</button>
        </div>
      </div>

      <!-- Roster Database Management -->
      <div class="flex flex-col space-y-1">
        <label class="block font-semibold mb-1 text-sm">Database</label>
        <div class="flex gap-2 flex-wrap items-center">
          <button type="button" id="loadFromDatabaseBtn" class="border border-blue-300 text-blue-600 hover:bg-blue-50 rounded px-3 py-1 text-xs font-medium">üîÑ Load from Database</button>
          <button type="button" id="viewDatabaseBtn" class="border border-gray-300 rounded px-3 py-1 text-xs text-gray-700 hover:bg-gray-50">üìä View Database</button>
          <button type="button" id="clearDatabaseBtn" class="border border-red-300 text-red-600 hover:bg-red-50 rounded px-3 py-1 text-xs">üóëÔ∏è Clear Database</button>
          <span id="databaseStatus" class="text-xs text-gray-500">Database: Not loaded</span>
        </div>
        <div class="text-xs text-gray-500 mt-1">
          Use "Load from Database" to work with existing 499 employees, or upload new roster to update database
        </div>
      </div>

      <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2">üìã Build Schedule Board</button>
      
      <!-- Assignment History Controls -->
      <div class="flex gap-1 ml-4">
        <button type="button" id="undoBtn" class="border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 hover:bg-gray-50" title="Undo last assignment (Ctrl+Z)">‚Ü∂ Undo</button>
        <button type="button" id="redoBtn" class="border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 hover:bg-gray-50" title="Redo assignment (Ctrl+Y)">‚Ü∑ Redo</button>
      </div>
    </form>

    <!-- Summary row (7 columns) -->
    <div class="flex flex-wrap gap-3 mb-4">
      <div class="chip"><span class="font-medium">Date</span><span class="ml-2" id="displayDate">-</span></div>
      <div class="chip"><span class="font-medium">Day</span><span class="ml-2" id="displayDay">-</span></div>
      <div class="chip"><span class="font-medium">Shift</span><span class="ml-2" id="displayShift">-</span></div>
      <div class="chip"><span class="font-medium">Shift Type</span><span class="ml-2" id="displayShiftType">-</span></div>
      <div class="chip"><span class="font-medium">Site</span><span class="ml-2" id="displaySite">-</span></div>
      <div class="chip"><span class="font-medium">Planned HC</span><span class="ml-2" id="displayPlannedHC">0</span></div>
      <div class="chip"><span class="font-medium">Actual HC</span><span class="ml-2" id="displayActualHC">0</span></div>
    </div>

    <!-- Codes bar (compact) -->
    <div id="codesBar" class="hidden text-xs text-gray-600 mb-6"></div>

    <!-- Layout: left Unassigned sidebar + right board grid -->
    <div class="flex gap-4 mt-4">
      <aside id="leftPanel" class="w-64 bg-white border border-gray-200 rounded-xl p-3 h-[72vh] overflow-auto">
        <!-- Filter Controls -->
        <div id="filterControls" class="filter-controls">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Search</label>
              <input type="text" id="nameFilter" class="filter-input" placeholder="Name or ID...">
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Dept</label>
              <select id="deptFilter" class="filter-input">
                <option value="">All</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Shift</label>
              <select id="shiftFilter" class="filter-input">
                <option value="">All</option>
              </select>
            </div>
          </div>
          <div class="filter-row">
            <button id="clearFilters" class="filter-clear">Clear</button>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions">
          <div class="bulk-actions-controls">
            <span class="selected-count">0 selected</span>
            <button id="selectAllBtn" class="bulk-action-btn">Select All</button>
            <button id="clearSelectionBtn" class="bulk-action-btn">Clear</button>
            <select id="bulkAssignTarget" class="filter-input" style="min-width: 100px;">
              <option value="">Assign to...</option>
            </select>
            <button id="bulkAssignBtn" class="bulk-action-btn">Assign</button>
          </div>
        </div>

        <!-- Smart Assignment Tools -->
        <div id="smartAssignmentTools" class="smart-assignment-tools">
          <h3 class="smart-tools-title">Smart Assignment</h3>
          
          <!-- Auto Assignment -->
          <div class="smart-tool-group">
            <button id="autoAssignBtn" class="smart-tool-btn auto-assign">
              ü§ñ Auto-Assign All
            </button>
            <p class="smart-tool-desc">Automatically assign all unassigned associates based on capacity and skills</p>
          </div>
          
          <!-- Quick Selection Tools -->
          <div class="smart-tool-group">
            <label class="smart-tool-label">Quick Select:</label>
            <div class="quick-select-buttons">
              <button id="selectByShiftBtn" class="quick-select-btn">By Shift</button>
              <button id="selectByDeptBtn" class="quick-select-btn">By Dept</button>
              <button id="selectFirstNBtn" class="quick-select-btn">First N</button>
            </div>
          </div>
          
          <!-- Rapid Assignment -->
          <div class="smart-tool-group">
            <label class="smart-tool-label">Rapid Assign:</label>
            <div class="rapid-assign-grid">
              <input type="number" id="rapidCount" class="rapid-count-input" placeholder="Count" min="1">
              <select id="rapidTarget" class="rapid-target-select">
                <option value="">To process...</option>
              </select>
              <button id="rapidAssignBtn" class="rapid-assign-btn">Assign</button>
            </div>
          </div>
          
          <!-- Fill to Capacity -->
          <div class="smart-tool-group">
            <button id="fillCapacityBtn" class="smart-tool-btn fill-capacity">
              üìä Fill All to Capacity
            </button>
            <p class="smart-tool-desc">Fill all process paths to their target capacity using unassigned associates</p>
          </div>
        </div>

        <div class="flex items-center justify-between mb-2">
            <h2 class="text-sm font-semibold">
              <span id="unassignedSiteLabel">Unassigned</span>
            </h2>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-600" id="unassignedCount">0</span>
              <button id="toggleUnassignedBtn" aria-expanded="false" aria-controls="unassignedStack" class="text-sm text-gray-500 border rounded p-1 hover:bg-gray-100">‚ñæ</button>
            </div>
          </div>
          <div id="unassignedStack" class="stack-column"></div>
      </aside>

      <div class="flex-1">
        <!-- Output / messages -->
        <div id="output" class="my-2 min-h-[60px]"></div>
        <!-- Board canvas (whiteboard) -->
  <div class="board-canvas bg-white border rounded-lg p-2 shadow-sm">
    <div class="process-grid">
      <div class="board-card"><div class="tile-header"><span class="font-semibold">CB</span><input id="tile-cb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">IB WS</span><input id="tile-ibws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Line Loaders</span><input id="tile-lineloaders" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Trickle</span><input id="tile-trickle" class="board-count-input" type="number" min="0"></div></div>

      <div class="board-card"><div class="tile-header"><span class="font-semibold">Destination Markers</span><input id="tile-dm" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">IDRT</span><input id="tile-idrt" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Pallet Build</span><input id="tile-pb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Each to Sort</span><input id="tile-e2s" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Dock WS</span><input id="tile-dockws" class="board-count-input" type="number" min="0"></div></div>

      <div class="board-card"><div class="tile-header"><span class="font-semibold">E2S WS</span><input id="tile-e2sws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Tote Pallet Build</span><input id="tile-tpb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Tote WS</span><input id="tile-tws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">SAP</span><input id="tile-sap" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">AO/5S</span><input id="tile-ao5s" class="board-count-input" type="number" min="0"></div></div>

      <!-- New process paths -->
      <div class="board-card"><div class="tile-header"><span class="font-semibold">PA (Process Assistant)</span><input id="tile-pa" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">PS (Problem Solvers)</span><input id="tile-ps" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Labor Share</span><input id="tile-laborshare" class="board-count-input" type="number" min="0"></div></div>
    </div>
  </div>
      </div>
    </div>
  </main>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- App logic -->
  <script src="app.js"></script>

  <script>
    // Show file names
    ['roster','missing','logins'].forEach(function(id) {
      const input = document.getElementById(id);
      const label = document.getElementById('label-'+id);
      if (!input) return;
      input.addEventListener('change', () => {
        const name = (input.files && input.files[0]) ? input.files[0].name : '';
        console.debug('[file-change]', id, 'files=', input.files, 'name=', name);
        if (label) label.textContent = name;
        // Keep a reference in case the input is later cleared by other DOM operations
        window.__LAST_UPLOADS = window.__LAST_UPLOADS || {};
        window.__LAST_UPLOADS[id] = (input.files && input.files[0]) ? input.files[0] : null;
      });
    });

    // Download Upload Template - Same format as roster with 2 examples
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
      const templateData = `Employee ID	User ID	Employee Name	Badge Barcode ID	Department ID	Employment Start Date	Employment Type	Employee Status	Manager Name	Management Area ID	Shift Pattern
110888249	qruchikr	Ruchika,Ruchika	13966332	1299020	Wed Sep 22 00:00:00 UTC 2021	AMZN	Active	Bhatt,Devashish	3	DA6C0700
204374752	ipanidhi	Patel,Nidhi	11300296	1211070	Tue Jun 10 00:00:00 UTC 2025	TEMP	Active	Gray,Torii	22	NL6C1930`;
      
      const blob = new Blob([templateData], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'upload-template.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      console.log('[DOWNLOAD] Downloaded upload template');
    });
  </script>
  <!-- Analytics Dashboard Modal -->
  <div id="analyticsModal" class="analytics-modal hidden">
    <div class="analytics-modal-content">
      <div class="analytics-header">
        <h2 class="text-xl font-bold">Workforce Analytics</h2>
        <button id="closeAnalyticsBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>

      <!-- Analytics Search -->
      <div class="analytics-search">
        <input id="analyticsSearchInput" type="text" class="analytics-search-input" placeholder="Search by associate login or name..." aria-label="Search analytics by associate login or name" />
        <div id="analyticsSearchResults" class="analytics-search-results hidden" aria-live="polite"></div>
      </div>
      
      <div class="analytics-tabs">
        <button class="analytics-tab active" data-tab="overview">Overview</button>
        <button class="analytics-tab" data-tab="performance">Performance</button>
        <button class="analytics-tab" data-tab="assignments">Assignments</button>
        <button class="analytics-tab" data-tab="rotation">Smart Rotation</button>
        <button class="analytics-tab" data-tab="insights">Insights</button>
      </div>
      
      <!-- Overview Tab -->
      <div id="tab-overview" class="analytics-tab-content">
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3>Session Summary</h3>
            <div id="sessionSummary" class="analytics-content">
              <p>Loading session data...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Assignment Activity</h3>
            <div id="assignmentActivity" class="analytics-content">
              <p>Loading assignment data...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Process Distribution</h3>
            <div id="processDistribution" class="analytics-content">
              <p>Loading process data...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Efficiency Metrics</h3>
            <div id="efficiencyMetrics" class="analytics-content">
              <p>Loading efficiency data...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Performance Tab -->
      <div id="tab-performance" class="analytics-tab-content hidden">
        <div class="analytics-grid">
          <div class="analytics-card full-width">
            <h3>Employee Performance Rankings</h3>
            <div id="performanceRankings" class="analytics-content">
              <p>Loading performance data...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Top Performers</h3>
            <div id="topPerformers" class="analytics-content">
              <p>Loading top performers...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Skill Development</h3>
            <div id="skillDevelopment" class="analytics-content">
              <p>Loading skill data...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Assignments Tab -->
      <div id="tab-assignments" class="analytics-tab-content hidden">
        <div class="analytics-grid">
          <div class="analytics-card full-width">
            <div class="flex items-center justify-between mb-4">
              <h3>Assignment History</h3>
              <div class="flex items-center gap-2">
                <label for="quarterFilter" class="text-sm font-medium">Quarter:</label>
                <select id="quarterFilter" class="border rounded px-2 py-1 text-sm">
                  <option value="all">All Quarters</option>
                  <option value="Q1">Q1</option>
                  <option value="Q2">Q2</option>
                  <option value="Q3">Q3</option>
                </select>
              </div>
            </div>
            <div id="assignmentHistory" class="analytics-content">
              <p>Loading assignment history...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Assignment Patterns</h3>
            <div id="assignmentPatterns" class="analytics-content">
              <p>Loading pattern analysis...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Recommendations</h3>
            <div id="assignmentRecommendations" class="analytics-content">
              <p>Loading recommendations...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Smart Rotation Tab -->
      <div id="tab-rotation" class="analytics-tab-content hidden">
        <div class="analytics-grid">
          <div class="analytics-card full-width">
            <h3>Smart Assignment Queue</h3>
            <div id="smartAssignmentQueue" class="analytics-content">
              <p>Loading smart assignments...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Rotation Alerts</h3>
            <div id="rotationAlertsPanel" class="analytics-content">
              <p>Loading rotation alerts...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Fairness Metrics</h3>
            <div id="rotationFairnessMetrics" class="analytics-content">
              <p>Loading fairness data...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Insights Tab -->
      <div id="tab-insights" class="analytics-tab-content hidden">
        <div class="analytics-grid">
          <div class="analytics-card full-width">
            <h3>Workforce Insights</h3>
            <div id="workforceInsights" class="analytics-content">
              <p>Loading insights...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Training Opportunities</h3>
            <div id="trainingOpportunities" class="analytics-content">
              <p>Loading training data...</p>
            </div>
          </div>
          
          <div class="analytics-card">
            <h3>Productivity Trends</h3>
            <div id="productivityTrends" class="analytics-content">
              <p>Loading trend data...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="analytics-footer">
        <button id="exportAnalyticsBtn" class="border border-blue-600 text-blue-600 bg-white hover:bg-blue-50 rounded px-4 py-2 text-sm">Export Analytics</button>
        <button id="clearAnalyticsBtn" class="border border-red-600 text-red-600 bg-white hover:bg-red-50 rounded px-4 py-2 text-sm">Clear Data</button>
      </div>
    </div>
  </div>

  <!-- Exit Publish button (placed outside header so it's visible in published mode) -->
  <button id="exitPublishBtn" class="border border-red-600 text-red-600 bg-white hover:bg-red-50 rounded px-3 py-1 text-sm font-semibold hidden">Exit Publish</button>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

</body>
</html>
